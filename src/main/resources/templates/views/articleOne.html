<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/article.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script th:inline="javascript">
		$().ready(function() {
            const articleId = [[${articleVO.articleId}]]
            const boardUrl = [[${boardVO.boardUrl}]]
			$("#modal-wrapper").click(function() {
			})
            $(".close").click(function() {
                location.reload();
            })
			$("#article-modify").click(function() {
				$("#modal-wrapper").removeClass("hidden")
				$("#password-submit-btn").click(function() {
                    let mdfyForm = $('<form></form>')
                    mdfyForm.attr("action", "modify")
                    mdfyForm.attr("method", "post")
                    let articleIdDom = $('<input type="hidden"/>')
                    articleIdDom.attr("name", "articleId")
                    articleIdDom.val(articleId);
                    let articlePwDom = $('<input type="hidden"/>')
                    articlePwDom.attr("name", "articlePassword")
                    articlePwDom.val($("#password-confirm").val());
                    mdfyForm.append(articleIdDom)
                    mdfyForm.append(articlePwDom)
                    $("body").append(mdfyForm)
                    mdfyForm.submit()
				})
			})
			$("#article-delete").click(function() {
				$("#modal-wrapper").removeClass("hidden")
				$("#password-submit-btn").click(function() {
                    let deleteForm = $('<form></form>')
                    deleteForm.attr("action", "delete")
                    deleteForm.attr("method", "post")
                    let articleIdDom = $('<input type="hidden"/>')
                    articleIdDom.attr("name", "articleId")
                    articleIdDom.val(articleId);
                    let articlePwDom = $('<input type="hidden"/>')
                    articlePwDom.attr("name", "articlePassword")
                    articlePwDom.val($("#password-confirm").val());
                    deleteForm.append(articleIdDom)
                    deleteForm.append(articlePwDom)
                    $("body").append(deleteForm)
                    deleteForm.submit()
				})
			})
            $(".reply-delete").click(function() {
				let replyId = $(this).closest(".reply-item").data("id");
				let replyPW = $(this).parent().find(".replyPW").val();
				$("#modal-wrapper").removeClass("hidden")
				$("#password-submit-btn").click(function() {
					var isCorrect =  replyPW === $("#password-confirm").val()
					if (isCorrect) {
                        if (confirm("댓글을 삭제합니다")) {
                            let deleteForm = $('<form></form>')
                            deleteForm.attr("action", "/reply/delete")
                            deleteForm.attr("method", "post")
                            let replyIdDom = $('<input type="text"/>')
                            replyIdDom.attr("name", "replyId")
                            replyIdDom.val(replyId)
                            let articleIdDom = $('<input type="text"/>')
                            articleIdDom.attr("name", "articleId")
                            articleIdDom.val(articleId);
                            deleteForm.append(replyIdDom)
                            deleteForm.append(articleIdDom)
                            $("body").append(deleteForm)
                            deleteForm.submit();
                        } else {
							location.reload();
						}
					} else {
						alert("잘못된 비밀번호입니다!")
						location.reload();
					}
				})
            })
            $(".reply-modify").click(function() {
				let replyId = $(this).closest(".reply-item").data("id");
				let replyPW = $(this).parent().find(".replyPW").val();
                let replyWriter = $(this).closest(".reply-item").find(".user-nickname").text();
                let replyContent = $(this).closest(".reply-item").find(".reply-content").text();
                $("#modify-writer").val(replyWriter)
                $("#modify-content").val(replyContent)
				$("#modal-wrapper").removeClass("hidden")
				$("#password-submit-btn").click(function() {
					var isCorrect =  replyPW === $("#password-confirm").val()
					if (isCorrect) {
                        $("#modal-password").addClass("hidden")
                        $("#modal-modify").removeClass("hidden")
                            let replyIdDom = $('<input type="hidden"/>')
                            replyIdDom.attr("name", "replyId")
                            replyIdDom.val(replyId)
                            $("#modify-form").append(replyIdDom)
					} else {
						alert("잘못된 비밀번호입니다!")
						location.reload();
					}
				})
            })

            $("#modify-submit").click(function() {
				if(confirm("댓글을 수정합니다")) {
	                $("#modify-form").submit()
				}
            })
		})
	</script>
</head>
<body>
	<div th:replace="~{./boardNav :: gnv}"></div>
    <div id="container">
        <div id="article-wrapper">
            <div id="article">
                <div id="article-title">
                    <h3 th:text="${articleVO.articleTitle}">제목입니다</h3>
                    <div class="flex-row">
                        <ul class="flex-row writer-info">
                            <li><span class="user-nickname" th:text="${articleVO.memberName}">닉네임</span></li>
                            <li>작성:<span th:text="${articleVO.articleCreateDate}"></span></li>
                            <th:block th:if="${articleVO.articleModifyDate != null}">
                            	<li>수정:<span th:text="${articleVO.articleModifyDate}"></span></li>
                            </th:block>
                            <li>조회수<span th:text="${articleVO.viewCnt}"></span></li>
                        </ul>
                        <ul class="flex-row add-delete">
                            <input type="hidden" th:value="${articleVO.articlePassword}" id="articlePW">
                            <li id="article-modify" class="pointer">수정</li>
                            <li id="article-delete" class="pointer">삭제</li>
                        </ul>
                    </div>
                </div>
                <div id="article-content">
					<p th:text="${articleVO.articleContent}"></p>
                </div>
                <th:block th:if="${!fileList.empty}">
                    <div id="article-file">
                        <h5>첨부파일</h5>
                        <ul class="flex-row" th:each="file : ${fileList}" >
                            <li><a th:href="@{|/file/download/${file.attachmentId}|}" th:text="${file.originFilename}"></a></li>
                        </ul>
                    </div>
                </th:block>
                <div id="replies-list">
					<h5>댓글</h5>
                    <th:block th:if="${replyList.empty}">
                        <div class="reply-item">
                            아직 작성된 댓글이 없습니다!
                        </div>
                    </th:block>
                    <div class="reply-item" th:each="replyVO : ${replyList}" th:data-id="${replyVO.replyId}">
                        <div class="flex-row">
                            <ul class="flex-row writer-info">
                                <li><span class="user-nickname" th:text="${replyVO.memberName}"></span></li>
                                <li>작성:<span th:text="${replyVO.replyCreateDate}"></span></li>
                                <th:block th:if="${replyVO.replyModifyDate != null}">
                                	<li>수정:<span th:text="${replyVO.replyModifyDate}"></li>
                                </th:block>
                            </ul>
                            <ul class="flex-row add-delete">
                                <input type="hidden" class="replyPW" th:value="${replyVO.replyPassword}">
                                <li class="reply-modify pointer">수정</li>
                                <li class="reply-delete pointer">삭제</li>
                            </ul>
                        </div>
                        <div class="reply-content" th:text="${replyVO.replyContent}"></div>
                    </div>
                </div>
                <div id="reply-write-wrapper">
                    <h5>댓글 쓰기</h5>
	                <form th:action="@{/reply/write}" th:object="${replyVO}" method="post">
	                    <div id="replies-write">
	                        <div class="flex-col">
	                            <input type="text" name="memberName" id="member-name" placeholder="댓글 작성자">
	                            <input type="password" name="replyPassword" id="reply-password" placeholder="비밀번호">
	                        </div>
	                        <textarea name="replyContent" id="reply-write" placeholder="댓글 내용"></textarea>
	                        <input type="hidden" name="articleId" th:value="${articleVO.articleId}">
	                        <input id="reply-submit" class="btn-green" type="submit" value="등록">
	                    </div>
	                </form>
                </div>
            </div>
            <div id="" class="flex-col flex-start article-link-group">
                <div>
                    <span>다음</span>
                    <a th:href="@{|/${boardVO.boardUrl}/view?articleId=${nextArticle.nextArticleId}|}" th:text="${nextArticle.nextArticleTitle}" class="font-bold">다음 글의 제목입니다</a>
                </div>
                <div>
                    <span>이전</span>
                    <a th:href="@{|/${boardVO.boardUrl}/view?articleId=${nextArticle.prevArticleId}|}" th:text="${nextArticle.prevArticleTitle}" class="font-bold">이전 글의 제목입니다</a>
                </div>
            </div>
            <div id="" class="flex-row flex-end article-btn-group">
                <a th:href="@{/write(boardId=${articleVO.boardId},upperArticleId=${articleVO.articleId})}" class="btn-green">답글 작성</a>
                <a th:href="@{|/${boardVO.boardUrl}|}" class="btn-white">목록</a>
            </div>
        </div>
    </div>
    <div id="modal-wrapper" class="hidden">
        <div id="modal-password" class="flex-col">
            <span class="close">❌</span>
            <h3>비밀번호 확인</h3>
            <input type="password" name="password-confirm" id="password-confirm" />
            <button id="password-submit-btn" class="btn-green">확인</button>
        </div>
        <div id="modal-modify" class="hidden">
            <span class="close">❌</span>
            <form th:action="@{/reply/modify}" th:object="${replyVO}" method="post" id="modify-form">
                <div id="replies-modify">
                    <div class="flex-col">
                        <h5>댓글 수정</h5>
                        <input type="text" name="memberName" id="modify-writer" placeholder="댓글 작성자" readonly>
                    </div>
                    <textarea name="replyContent" id="modify-content" placeholder="댓글 내용"></textarea>
                    <input type="hidden" name="articleId" th:value="${articleVO.articleId}">
                    <button id="modify-submit" class="btn-green" type="button">등록</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>